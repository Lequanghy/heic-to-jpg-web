<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HEIC → JPG Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body
    class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen flex items-center justify-center p-4"
  >
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl w-full">
      <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">
        HEIC to JPG Converter
      </h1>
      <p class="text-center text-gray-600 mb-8">
        Free, instant, no upload limits
      </p>

      <form id="uploadForm" class="space-y-6">
        <div
          id="dropZone"
          class="border-4 border-dashed border-purple-300 rounded-xl p-12 text-center cursor-pointer hover:border-purple-500 transition"
        >
          <i class="fas fa-cloud-upload-alt text-6xl text-purple-400 mb-4"></i>
          <p class="text-xl text-gray-700">
            Drop HEIC files here or click to browse
          </p>
          <input
            type="file"
            name="files"
            id="fileInput"
            multiple
            accept=".heic,.HEIC,.heif,.HEIF"
            class="hidden"
          />
        </div>

        <div id="progress" class="hidden">
          <div class="text-sm text-gray-600 mb-2">Converting...</div>
          <div class="w-full bg-gray-200 rounded-full h-3">
            <div
              id="progressBar"
              class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all"
              style="width: 0%"
            ></div>
          </div>
        </div>

        <div id="results" class="space-y-3"></div>
      </form>
    </div>

    <script>
      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const progress = document.getElementById("progress");
      const progressBar = document.getElementById("progressBar");
      const results = document.getElementById("results");

      // PREVENT BROWSER FROM OPENING/DOWNLOADING THE DROPPED FILE
      dropZone.addEventListener("dragover", (e) => e.preventDefault(), false);
      dropZone.addEventListener("drop", (e) => e.preventDefault(), false);

      ["dragover", "dragenter"].forEach((e) => {
        dropZone.addEventListener(e, () =>
          dropZone.classList.add("border-purple-600", "bg-purple-50")
        );
      });
      ["dragleave", "dragend", "drop"].forEach((e) => {
        dropZone.addEventListener(e, () =>
          dropZone.classList.remove("border-purple-600", "bg-purple-50")
        );
      });

      dropZone.addEventListener("click", () => fileInput.click());

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener("change", () => handleFiles(fileInput.files));

      async function handleFiles(files) {
        const heicFiles = Array.from(files).filter((f) =>
          /.(heic|heif)$/i.test(f.name)
        );
        if (heicFiles.length === 0) {
          alert("No HEIC/HEIF files found!");
          return;
        }

        progress.classList.remove("hidden");
        results.innerHTML = "";
        let completed = 0;

        for (const file of heicFiles) {
          const formData = new FormData();
          formData.append("file", file);

          try {
            const res = await fetch("/convert", {
              method: "POST",
              body: formData,
            });

            const blob = await res.blob();
            const url = URL.createObjectURL(blob);

            const div = document.createElement("div");
            div.className =
              "flex items-center justify-between bg-green-50 p-4 rounded-lg border border-green-200";
            div.innerHTML = `
                <span class="font-medium text-green-800">${
                  file.name
                } → ${file.name.replace(/\.hei[c|f]/i, ".jpg")}</span>
                <a href="${url}" download="${file.name.replace(
              /\.hei[c|f]/i,
              ".jpg"
            )}"
                   class="bg-green-600 hover:bg-green-700 text-white px-5 py-2 rounded-lg transition">
                  Download
                </a>
              `;
            results.appendChild(div);

            completed++;
            progressBar.style.width =
              (completed / heicFiles.length) * 100 + "%";
          } catch (err) {
            results.innerHTML += `<div class="text-red-600">Failed: ${file.name}</div>`;
          }
        }

        if (completed === heicFiles.length) {
          setTimeout(() => progress.classList.add("hidden"), 1000);
        }
      }
    </script>
  </body>
</html>
