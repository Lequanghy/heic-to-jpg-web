<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="title">HEIC → JPG Converter</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/jszip@3.10.1/dist/jszip.min.js"></script>
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
      rel="stylesheet"
    />
  </head>
  <body
    class="bg-gradient-to-br from-purple-50 to-pink-50 min-h-screen flex p-4 flex flex-col"
  >
    <main class="flex-1 flex items-center justify-center pb-10">
      <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-2xl">
        <div class="flex items-center justify-center mb-4">
          <h1 class="text-4xl font-bold text-center text-gray-800 mb-2">
            Convert HEIC to&nbsp;
          </h1>

          <div class="relative inline-block text-left mb-1">
            <!-- Button displaying the selected value -->
            <button
              id="dropdownButton"
              class="inline-flex justify-between w-48 rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-4xl font-bold text-gray-800 hover:bg-gray-50 focus:outline-none"
            >
              <span id="selectedNewFormat">JPG</span>

              <svg
                class="h-5 w-5 ml-2"
                xmlns="http://www.w3.org/2000/svg"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M19 9l-7 7-7-7"
                />
              </svg>
            </button>

            <!-- Dropdown menu -->
            <div
              id="dropdownMenu"
              class="hidden absolute left-0 mt-2 w-48 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5"
            >
              <div class="py-1">
                <button
                  data-value="JPG"
                  class="option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  <div>
                    <div class="font-medium">JPG</div>
                    <div class="text-xs text-gray-500">
                      Best compatibility · 95% quality
                    </div>
                  </div>
                </button>

                <button
                  data-value="PNG"
                  class="option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  <div>
                    <div class="font-medium">PNG</div>
                    <div class="text-xs text-gray-500">
                      Lossless · Transparent support
                    </div>
                  </div>
                </button>

                <button
                  data-value="AVIF"
                  class="option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  <div>
                    <div class="font-medium">AVIF</div>
                    <div class="text-xs text-gray-500">
                      Next-gen · Best compression (2025)
                    </div>
                  </div>
                </button>

                <button
                  data-value="WebP"
                  class="option block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100"
                >
                  <div>
                    <div class="font-medium">WebP</div>
                    <div class="text-xs text-gray-500">
                      Smallest size · Modern browsers
                    </div>
                  </div>
                </button>
              </div>
            </div>
          </div>
        </div>
        <p class="text-center text-gray-600 mb-8">
          Free, instant, no upload limits
        </p>

        <form id="uploadForm" class="space-y-6">
          <div
            id="dropZone"
            class="border-4 border-dashed border-purple-300 rounded-xl p-12 text-center cursor-pointer hover:border-purple-500 transition"
          >
            <i
              class="fas fa-cloud-upload-alt text-6xl text-purple-400 mb-4"
            ></i>
            <p class="text-xl text-gray-700">
              Drop HEIC files here or click to browse
            </p>
            <input
              type="file"
              name="files"
              id="fileInput"
              multiple
              accept=".heic,.HEIC,.heif,.HEIF"
              class="hidden"
            />
          </div>

          <div id="progress" class="hidden">
            <div class="text-sm text-gray-600 mb-2">Converting...</div>
            <div class="w-full bg-gray-200 rounded-full h-3">
              <div
                id="progressBar"
                class="bg-gradient-to-r from-purple-500 to-pink-500 h-3 rounded-full transition-all"
                style="width: 0%"
              ></div>
            </div>
          </div>
          <div
            id="downloadAll"
            class="space-y-3 flex justify-center w-full hidden"
          >
            <a
              id="downloadAllLink"
              class="px-10 py-3 w-full bg-green-600 text-white text-center rounded-xl hover:bg-green-700"
            >
              Download All
            </a>
          </div>
          <div id="results" class="space-y-3"></div>
        </form>
      </div>
    </main>

    <footer
      class="relative z-20 py-5 border-t border-gray-200 bg-white/70 backdrop-blur-sm w-full"
    >
      <div class="flex items-center justify-center gap-3 text-gray-600">
        <span class="text-sm font-medium"
          >Crafted by
          <span class="font-bold text-indigo-600">Le Quang Hy</span></span
        >
        <span class="text-gray-400">•</span>
        <a
          href="https://github.com/Lequanghy/heic-to-jpg-web"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 text-gray-600 hover:text-indigo-600 transition group"
        >
          <i class="fab fa-github text-xl group-hover:scale-110 transition"></i>
        </a>
      </div>
    </footer>

    <script>
      const btn = document.getElementById("dropdownButton");
      const menu = document.getElementById("dropdownMenu");
      const selectedNewFormat = document.getElementById("selectedNewFormat");
      const title = document.getElementById("title");

      btn.addEventListener("click", () => {
        menu.classList.toggle("hidden");
      });

      // When an option is clicked
      document.querySelectorAll(".option").forEach((option) => {
        option.addEventListener("click", () => {
          selectedNewFormat.textContent = option.dataset.value; // display selected
          menu.classList.add("hidden"); // close menu
          title.textContent = `HEIC → ${option.dataset.value} Converter`;
        });
      });

      // close if clicking outside
      document.addEventListener("click", (e) => {
        if (!btn.contains(e.target) && !menu.contains(e.target)) {
          menu.classList.add("hidden");
        }
      });

      const dropZone = document.getElementById("dropZone");
      const fileInput = document.getElementById("fileInput");
      const progress = document.getElementById("progress");
      const progressBar = document.getElementById("progressBar");
      const results = document.getElementById("results");
      const downloadAll = document.getElementById("downloadAll");

      // PREVENT BROWSER FROM OPENING/DOWNLOADING THE DROPPED FILE
      dropZone.addEventListener("dragover", (e) => e.preventDefault(), false);
      dropZone.addEventListener("drop", (e) => e.preventDefault(), false);

      ["dragover", "dragenter"].forEach((e) => {
        dropZone.addEventListener(e, () =>
          dropZone.classList.add("border-purple-600", "bg-purple-50")
        );
      });
      ["dragleave", "dragend", "drop"].forEach((e) => {
        dropZone.addEventListener(e, () =>
          dropZone.classList.remove("border-purple-600", "bg-purple-50")
        );
      });

      dropZone.addEventListener("click", () => fileInput.click());

      dropZone.addEventListener("drop", (e) => {
        e.preventDefault();
        handleFiles(e.dataTransfer.files);
      });

      fileInput.addEventListener("change", () => handleFiles(fileInput.files));

      async function handleFiles(files) {
        const heicFiles = Array.from(files).filter((f) =>
          /.(heic|heif)$/i.test(f.name)
        );
        const selectedNewFormat = document.getElementById("selectedNewFormat");
        const newFormat = selectedNewFormat.textContent.toLowerCase();

        if (heicFiles.length === 0) {
          alert("No HEIC/HEIF files found!");
          return;
        }

        // Count the number of uploaded files
        window.convertedFiles = [];
        window.totalFilesToConvert = heicFiles.length;
        document.getElementById("results").innerHTML = ""; // Clear old results

        heicFiles.forEach((file) => convertAndDownload(file, newFormat));
      }

      async function convertAndDownload(file, format = "jpg") {
        downloadAll.classList.add("hidden");
        const resultDiv = document.createElement("div");
        resultDiv.className =
          "bg-white rounded-2xl shadow-md p-6 flex items-center justify-between animate-fade-in";
        resultDiv.innerHTML = `
                 <div class="flex items-center space-x-5">
                   <i class="fa-solid fa-image text-5xl text-gray-400"></i>
                   <div>
                     <p class="font-bold text-lg">${file.name}</p>
                     <p class="text-sm text-gray-600">Converting to <strong>${format.toUpperCase()}</strong>...</p>
                   </div>
                 </div>
                 <i class="fa-solid fa-spinner fa-spin text-3xl text-indigo-600"></i>
               `;
        document.getElementById("results").prepend(resultDiv);

        const form = new FormData();
        form.append("file", file);
        form.append("format", format);

        try {
          const res = await fetch("/convert", { method: "POST", body: form });
          if (!res.ok) throw new Error("Failed");

          const blob = await res.blob();
          const url = URL.createObjectURL(blob);
          const newName = file.name.replace(
            /\.(heic|heif)$/i,
            `.${format === "jpg" ? "jpg" : format}`
          );

          // Store for ZIP later
          window.convertedFiles = window.convertedFiles || [];
          window.convertedFiles.push({ name: newName, blob, url });

          // Success UI
          resultDiv.innerHTML = `
               <div class="flex items-center space-x-5">
                 <i class="fa-solid fa-check-circle text-5xl text-green-600"></i>
                 <div>
                   <p class="font-bold text-lg">${newName}</p>
                   <p class="text-sm text-green-600">Ready!</p>
                 </div>
               </div>
               <a href="${url}" download="${newName}" class="px-6 py-3 bg-green-600 text-white rounded-xl hover:bg-green-700">
                 Download
               </a>
             `;
        } catch (err) {
          resultDiv.innerHTML = `<p class="text-red-600 font-bold">Failed: ${err.message}</p>`;
        }

        try {
          const downloadAll = document.getElementById("downloadAll");
          const a = document.getElementById("downloadAllLink");

          if (window.convertedFiles.length > 1) {
            downloadAll.classList.remove("hidden");
            const zipFile = new JSZip();
            window.convertedFiles.forEach((f) => zipFile.file(f.name, f.blob));
            const zipBlob = await zipFile.generateAsync({ type: "blob" });
            const zipUrl = URL.createObjectURL(zipBlob);
            a.href = zipUrl;
            a.download = `heic-converted-${new Date()
              .toISOString()
              .slice(0, 10)}.zip`;
          }
        } catch (err) {
          downloadAll.innerHTML = `<p class="text-red-600 font-bold">Failed: ${err.message}</p>`;
        }
      }
    </script>
  </body>
</html>
